"use strict";function kmeans(t,e,r){var n=new Array,a=new Array,o=new Array,i=!1;r||(r=function(t){return[t]});for(var l=function(t){for(var e=[],r=t[0].length,n=0;n<r;n++)e.push(t.map(function(t){return t[n]}).reduce(function(t,e){return t+e},0)/t.length);return e},s=function(t,e){for(var r=0;r<=t.length;r++)if(t[r]!==e[r])return!1;return!0},d=function(t,e){for(var r=0;r<=t.length;r++)if(s(t[r],e))return!0;return!1},u=0;u<e;u++)n[u]=new Array;var c,p,f,h=Math.round(t.length/(e+1));for(c=0;c<e;c++)f=h*(c+1),a[c]=r(t[f]);do{for(p=0;p<e;p++)n[p]=[];for(i=!1,c=0;c<t.length;c++){var m,y=-1,g=-1;for(p=0;p<e;p++)y=function(t,e){if(t=(void 0===t?"undefined":_typeof(t))===Array?t:[t],e=(void 0===e?"undefined":_typeof(e))===Array?e:[e],t.length!==e.length)throw"Number of dimensions not aligned between data points.";for(var r=0,n=0;n<t.length;n++)r+=Math.pow(t[n]-e[n],2);return Math.sqrt(r)}(a[p],r(t[c])),-1==g?(g=y,m=p):y<=g&&(m=p,g=y);n[m].push(t[c])}o=a,a=function(t){return t.map(l)}(n),i=function(t,e){for(var r=0;r<t.length;r++)if(!d(e,t[r]))return!0;return!1}(o,a)}while(1==i);return n}function MatrixViewer(t){d3.select(t).html('<div class="row px-3" style="width:100%" id="_matrixview">'+this.selectHTML+this.alertHTML+"</div>"+this.cmHTML+this.tooltipHTML),this.hideAlert(),this._parentId=t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};"undefined"!=typeof d3&&(d3.kmeans=kmeans),MatrixViewer.prototype.selectHTML='<p>Order by: <select id="order">  <option value="name">PDB ID</option>         <option value="group">cluster</option>     </select>',MatrixViewer.prototype.alertHTML='<div class="alert alert-light col-6" role="alert" id="alertbox">&nbsp;</div>',MatrixViewer.prototype.cmHTML='<div class="row"><div class="col-12"><matrix id="matrix"></matrix></div>',MatrixViewer.prototype.tooltipHTML='<div id="tooltip" class="hidden"><p><span id="value"></p></div></div>',MatrixViewer.prototype.clear=function(){this.hideAlert(),this._width=0,this.data=null,d3.select("matrix").select("svg").remove(),d3.select("matrix").select("*").remove()},MatrixViewer.prototype.alert=function(t){d3.select("#alertbox").html(t)},MatrixViewer.prototype.hideAlert=function(){d3.select("#alertbox").html("")},MatrixViewer.prototype._parse=function(t){var e=t.matrix,r=t.numClusters||3;try{var n=[],a=d3.dsvFormat("\t"),o=[],i={},l=0,s=a.parseRows(e,function(t,e){var r,a,s=t[0],d=t[1],u=parseFloat(t[2]),c=parseFloat(t[3]);return r=i[s],r||(l=n.length,r={name:s,index:l},i[s]=r,n.push(r)),a=i[d],a||(l=n.length,a={name:d,index:l},i[d]=a,n.push(a)),o.push({source:r.index,target:a.index,value:c}),{pdb1:s,pdb2:d,contact:u,rmsd:c}});return o=this.clusterKmeans(o,r),{matrix:s,pdbs:n,links:o}}catch(t){return this.alert("Wrong input format. Required format: [PDB1 PDB2 contact RMSD]"),null}},MatrixViewer.prototype.clusterKmeans=function(t,e){var r=d3.kmeans(t,e,function(t){return t.value}),n=new Array;return r.forEach(function(t,e){t.forEach(function(t,r){t.group=e+1}),n=n.concat(t)}),n},MatrixViewer.prototype.draw=function(t){if(this.clear(),null===t)return void this.alert("Input data is empty.");var e=parseInt(d3.select(this._parentId).style("padding-left")),r=parseInt(d3.select(this._parentId).style("padding-right"));this._width=parseInt(d3.select(this._parentId).style("width"))-e-r-15,this.data=this._parse(t),null!==this.data&&this._draw()},MatrixViewer.prototype._draw=function(){function t(t){d.domain(h[t]);var e=i.transition().duration(2e3);e.selectAll(".row").delay(function(t,e){return 4*d(e)}).attr("transform",function(t,e){return"translate(0,"+d(e)+")"}).selectAll(".cell").delay(function(t){return 4*d(t.x)}).attr("x",function(t){return d(t.x)}),e.selectAll(".column").delay(function(t,e){return 4*d(e)}).attr("transform",function(t,e){return"translate("+d(e)+")rotate(-90)"})}function e(t){d3.selectAll(".row text").classed("active",function(e,r){return r==t.y}),d3.selectAll(".column text").classed("active",function(e,r){return r==t.x}),m.transition().duration(200).style("opacity",.9);var e=l[t.x][t.y].group;m.html(a[t.y].name+" ["+e+"]</br>"+a[t.x].name+" ["+e+"]</br>RMSD: "+t.z).style("left",d3.event.pageX+30+"px").style("top",d3.event.pageY-50+"px")}function r(){d3.selectAll("text").classed("active",!1),m.transition().duration(500).style("opacity",0)}var n=this,a=n.data.pdbs,o={top:150,right:50,bottom:0,left:50,legend:{top:-100,left:10,width:50,height:50}},i=(o.legend.left,o.legend.width,d3.select("matrix").append("svg").attr("width",700+o.left+o.right).attr("height",700+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")"));i.append("rect").attr("class","background").attr("width",700).attr("height",700);var l=[],s=a.length,d=d3.scaleBand().range([0,700]).domain(d3.range(s)),u=d3.scaleOrdinal(d3.schemeCategory10);a.forEach(function(t){l[t.index]=d3.range(s).map(function(e){return{x:e,y:t.index,z:0}})}),n.data.links.forEach(function(t){l[t.source][t.target].z+=t.value,l[t.target][t.source].z+=t.value,l[t.source][t.target].group=t.group,l[t.target][t.source].group=t.group});var c=i.selectAll(".row").data(l).enter().append("g").attr("class","row").attr("transform",function(t,e){return"translate(0,"+d(e)+")"}),p=(c.selectAll(".cell").data(function(t){return t.filter(function(t){return t.z>0})}).enter().append("rect").attr("class","cell").attr("x",function(t){return d(t.x)}).attr("width",d.bandwidth()).attr("height",d.bandwidth()).style("fill",function(t){return u(t.group)}).on("mouseover",e).on("mouseout",r),i.selectAll(".column").data(l).enter().append("g").attr("class","column").attr("transform",function(t,e){return"translate("+d(e)+")rotate(-90)"}));c.append("text").attr("class","label").attr("x",-5).attr("y",d.bandwidth()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return a[e].name}),p.append("text").attr("class","label").attr("y",100).attr("y",d.bandwidth()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,e){return a[e].name});var f=d3.legendColor().title("Cluster id").labelFormat(d3.format(".0f")).shapeWidth(30).scale(u).orient("horizontal").labelOffset(12);i.append("g").attr("transform","translate("+o.legend.left+","+o.legend.top+")").call(f);var h={name:d3.range(s).sort(function(t,e){return d3.ascending(a[t].name,a[e].name)}),group:d3.range(s).sort(function(t,e){return t=Math.min(s-2,t),e=Math.min(s-2,e),l[t][t+1].z-l[e][e+1].z})};d3.select("#order").on("change",function(){t(this.value)}),c.append("line").attr("x2",700),p.append("line").attr("x1",-700);var m=d3.select("body").append("div").attr("class","tooltip").style("opacity",0)};