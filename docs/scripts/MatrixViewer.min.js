"use strict";function kmeans(t,e,r){var n=new Array,a=new Array,i=new Array,o=!1;r||(r=function(t){return[t]});for(var l=function(t){for(var e=[],r=t[0].length,n=0;n<r;n++)e.push(t.map(function(t){return t[n]}).reduce(function(t,e){return t+e},0)/t.length);return e},s=function(t,e){for(var r=0;r<=t.length;r++)if(t[r]!==e[r])return!1;return!0},c=function(t,e){for(var r=0;r<=t.length;r++)if(s(t[r],e))return!0;return!1},u=0;u<e;u++)n[u]=new Array;var d,p,f,h=Math.round(t.length/(e+1));for(d=0;d<e;d++)f=h*(d+1),a[d]=r(t[f]);do{for(p=0;p<e;p++)n[p]=[];for(o=!1,d=0;d<t.length;d++){var y,v=-1,m=-1;for(p=0;p<e;p++)v=function(t,e){if(t=(void 0===t?"undefined":_typeof(t))===Array?t:[t],e=(void 0===e?"undefined":_typeof(e))===Array?e:[e],t.length!==e.length)throw"Number of dimensions not aligned between data points.";for(var r=0,n=0;n<t.length;n++)r+=Math.pow(t[n]-e[n],2);return Math.sqrt(r)}(a[p],r(t[d])),-1==m?(m=v,y=p):v<=m&&(y=p,m=v);n[y].push(t[d])}i=a,a=function(t){return t.map(l)}(n),o=function(t,e){for(var r=0;r<t.length;r++)if(!c(e,t[r]))return!0;return!1}(i,a)}while(1==o);return n}function MatrixViewer(t){d3.select(t).html('<div class="row px-3" style="width:100%" id="_matrixview">'+this.selectHTML+this.colorHTML+this.alertHTML+"</div>"+this.cmHTML+this.tooltipHTML),this.hideAlert(),this._parentId=t}var clusterfck=function(){var t={exports:{}};t.exports;return t.exports=function(){var t={exports:{}},e=(t.exports,function(t,e,r){this.distance=t||clusterfck.EUCLIDEAN_DISTANCE,this.merge=e||clusterfck.AVERAGE_LINKAGE,this.threshold=void 0==r?1/0:r});e.prototype={cluster:function(t,e,r){for(var n=[],a=[],i=[],o=[],l=0;l<t.length;l++){var s={canonical:t[l],key:l,index:l,size:1};n[l]=s,o[l]=s,a[l]=[],i[l]=0}for(var l=0;l<n.length;l++)for(var c=0;c<=l;c++){var u=l==c?1/0:this.distance(n[l].canonical,n[c].canonical);a[l][c]=u,a[c][l]=u,u<a[l][i[l]]&&(i[l]=c)}for(var d=this.mergeClosest(n,a,i,o),l=0;d;)r&&l%e==0&&r(n),d=this.mergeClosest(n,a,i,o),l++;return n.forEach(function(t){delete t.key,delete t.index}),n},mergeClosest:function(t,e,r,n){for(var a=0,i=1/0,o=0;o<t.length;o++){var l=t[o].key,s=e[l][r[l]];s<i&&(a=l,i=s)}if(i>=this.threshold)return!1;var c=n[a],u=n[r[a]],d={canonical:this.merge(c.canonical,u.canonical),left:c,right:u,key:c.key,size:c.size+u.size};t[c.index]=d,t.splice(u.index,1),n[c.key]=d;for(var o=0;o<t.length;o++){var s,p=t[o];c.key==p.key?s=1/0:this.merge==clusterfck.SINGLE_LINKAGE?(s=e[c.key][p.key],e[c.key][p.key]>e[u.key][p.key]&&(s=e[u.key][p.key])):this.merge==clusterfck.COMPLETE_LINKAGE?(s=e[c.key][p.key],e[c.key][p.key]<e[u.key][p.key]&&(s=e[u.key][p.key])):s=this.merge==clusterfck.AVERAGE_LINKAGE?(e[c.key][p.key]*c.size+e[u.key][p.key]*u.size)/(c.size+u.size):this.distance(p.canonical,c.canonical),e[c.key][p.key]=e[p.key][c.key]=s}for(var o=0;o<t.length;o++){var f=t[o].key;if(r[f]==c.key||r[f]==u.key){for(var i=f,h=0;h<t.length;h++){var y=t[h].key;e[f][y]<e[f][i]&&(i=y)}r[f]=i}t[o].index=o}return delete c.key,delete u.key,delete c.index,delete u.index,!0}};var r=function(t,e){return t},n=function(t,e){return t},a=function(t,e){return t},i=function(t,e){for(var r=0,n=0;n<t.length;n++)r+=Math.pow(e[n]-t[n],2);return Math.sqrt(r)},o=function(t,e){for(var r=0,n=0;n<t.length;n++)r+=Math.abs(e[n]-t[n]);return r},l=function(t,e){for(var r=0,n=0;n<t.length;n++)r=Math.max(r,Math.abs(e[n]-t[n]));return r};return clusterfck={hcluster:function(t,r,n,a,i,o){return new e(r,n,a).cluster(t,i,o)},SINGLE_LINKAGE:r,COMPLETE_LINKAGE:n,AVERAGE_LINKAGE:a,EUCLIDEAN_DISTANCE:i,MANHATTAN_DISTANCE:o,MAX_DISTANCE:l},t.exports=clusterfck,t.exports}(),t.exports}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};"undefined"!=typeof d3&&(d3.kmeans=kmeans),MatrixViewer.prototype.selectHTML='<p>Order by: <select id="order">  <option value="rmsd">RMSD</option> <option value="name">PDB ID</option> <option value="group">cluster (k-means)</option> <option value="hcluster">cluster (hierarchical)</option>     </select>',MatrixViewer.prototype.colorHTML='<p>Color by: <select id="color">  <option value="rmsd">RMSD</option> <option value="cluster">cluster id (k-means)</option>     </select>',MatrixViewer.prototype.alertHTML='<div class="alert alert-light col-6" role="alert" id="alertbox">&nbsp;</div>',MatrixViewer.prototype.cmHTML='<div class="row"><div class="col-12"><matrix id="matrix"></matrix></div>',MatrixViewer.prototype.tooltipHTML='<div id="tooltip" class="hidden"><p><span id="value"></p></div></div>',MatrixViewer.prototype.clear=function(){this.hideAlert(),this._width=0,this.data=null,d3.select("matrix").select("svg").remove(),d3.select("matrix").select("*").remove()},MatrixViewer.prototype.alert=function(t){d3.select("#alertbox").html(t)},MatrixViewer.prototype.hideAlert=function(){d3.select("#alertbox").html("")},MatrixViewer.prototype._parse=function(t){var e=t.matrix,r=t.numClusters||3;try{var n=[],a=d3.dsvFormat("\t"),i=[],o={},l=0,s=[],c=a.parseRows(e,function(t,e){var r,a,c=t[0],u=t[1],d=parseFloat(t[2]),p=parseFloat(t[3]);return r=o[c],r||(l=n.length,r={name:c,index:l},o[c]=r,n.push(r),s[r.index]=s[r.index]||[],s[r.index][r.index]=0),a=o[u],a||(l=n.length,a={name:u,index:l},o[u]=a,n.push(a),s[a.index]=s[a.index]||[],s[a.index][a.index]=0),s[r.index][a.index]=p,s[a.index][r.index]=p,i.push({source:r.index,target:a.index,value:p}),{pdb1:c,pdb2:u,contact:d,rmsd:p}});i=this.clusterKmeans(i,r);var u=this.hcluster(s);return{matrix:c,pdbs:n,links:i,hclusters:u}}catch(t){return this.alert("Wrong input format. Required format: [PDB1 PDB2 contact RMSD]"),null}},MatrixViewer.prototype.hcluster=function(t){function e(t){var e=t.left||null,r=t.right||null,n=[];return e&&n.push(e),r&&n.push(r),n.length>0?n:null}var r=clusterfck.hcluster(t),n=d3.hierarchy(r[0],e);d3.cluster()(n);var a=n.leaves(),i=[];return a.forEach(function(e){var r=e.data.canonical,n=t.indexOf(r);i.push(n)}),i},MatrixViewer.prototype.clusterKmeans=function(t,e){var r=d3.kmeans(t,e,function(t){return t.value}),n=new Array;return r.forEach(function(t,e){t.forEach(function(t,r){t.group=e+1}),n=n.concat(t)}),n},MatrixViewer.prototype.draw=function(t){if(this.clear(),null===t)return void this.alert("Input data is empty.");var e=parseInt(d3.select(this._parentId).style("padding-left")),r=parseInt(d3.select(this._parentId).style("padding-right"));this._width=parseInt(d3.select(this._parentId).style("width"))-e-r-15,this.data=this._parse(t),null!==this.data&&this._draw();var n=document.getElementById("color");n.options[0].selected=!0,n.dispatchEvent(new Event("change")),n=document.getElementById("order"),n.options[0].selected=!0,n.dispatchEvent(new Event("change"))},MatrixViewer.prototype._draw=function(){function t(t){u.domain(v[t]);var e=l.transition().duration(2e3);e.selectAll(".row").delay(function(t,e){return 4*u(e)}).attr("transform",function(t,e){return"translate(0,"+u(e)+")"}).selectAll(".cell").delay(function(t){return 4*u(t.x)}).attr("x",function(t){return u(t.x)}),e.selectAll(".column").delay(function(t,e){return 4*u(e)}).attr("transform",function(t,e){return"translate("+u(e)+")rotate(-90)"})}function e(t){"rmsd"===t?(f=p,l.selectAll(".cell").transition().style("fill",function(t){t.z;return f(t.z)})):(f=d,l.selectAll(".cell").transition().style("fill",function(t){return f(t.group)}))}function r(t){d3.selectAll(".row text").classed("active",function(e,r){return r==t.y}),d3.selectAll(".column text").classed("active",function(e,r){return r==t.x}),m.transition().duration(200).style("opacity",.9);var e=s[t.x][t.y].group;m.html(i[t.y].name+"<br>"+i[t.x].name+"<br>[ cluster"+e+"]</br>RMSD: "+t.z).style("left",d3.event.pageX+30+"px").style("top",d3.event.pageY-50+"px")}function n(){d3.selectAll("text").classed("active",!1),m.transition().duration(500).style("opacity",0)}var a=this,i=a.data.pdbs,o={top:150,right:50,bottom:10,left:50,legend:{top:-100,left:10,width:50,height:50}},l=(o.left,o.right,o.legend.left,o.legend.width,d3.select("matrix").append("svg").attr("width",700+o.left+o.right).attr("height",700+o.top+o.bottom).append("g").attr("transform","translate("+o.left+","+o.top+")"));l.append("rect").attr("class","background").attr("width",700).attr("height",700);var s=[],c=i.length,u=(d3.max(a.data.links,function(t){return t.value}),d3.scaleBand().range([0,700]).domain(d3.range(c))),d=d3.scaleOrdinal(d3.schemeCategory10),p=d3.scaleSequential(d3.interpolateYlGnBu),f=p;i.forEach(function(t){s[t.index]=d3.range(c).map(function(e){return{x:e,y:t.index,z:0}})}),a.data.links.forEach(function(t){s[t.source][t.target].z+=t.value,s[t.target][t.source].z+=t.value,s[t.source][t.target].group=t.group,s[t.target][t.source].group=t.group});var h=l.selectAll(".row").data(s).enter().append("g").attr("class","row").attr("transform",function(t,e){return"translate(0,"+u(e)+")"}),y=(h.selectAll(".cell").data(function(t){return t.filter(function(t){return t.z>0})}).enter().append("rect").attr("class","cell").attr("x",function(t){return u(t.x)}).attr("width",u.bandwidth()).attr("height",u.bandwidth()).style("fill",function(t){return f(t.group)}).on("mouseover",r).on("mouseout",n),l.selectAll(".column").data(s).enter().append("g").attr("class","column").attr("transform",function(t,e){return"translate("+u(e)+")rotate(-90)"}));h.append("text").attr("class","label").attr("x",-5).attr("y",u.bandwidth()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return i[e].name}),y.append("text").attr("class","label").attr("y",100).attr("y",u.bandwidth()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,e){return i[e].name});var v={name:d3.range(c).sort(function(t,e){return d3.ascending(i[t].name,i[e].name)}),group:d3.range(c).sort(function(t,e){return t=Math.min(c-2,t),e=Math.min(c-2,e),s[t][t+1].value-s[e][e+1].value}),rmsd:d3.range(c).sort(function(t,e){var r=s[1][t].z,n=s[1][e].z;if(r!=n)return r-n;var r=s[c-1][t].z,n=s[c-1][e].z;return r-n}),hcluster:a.data.hclusters};d3.select("#order").on("change",function(){t(this.value)}),d3.select("#color").on("change",function(){e(this.value)});h.append("line").attr("x2",700),y.append("line").attr("x1",-700);var m=d3.select("body").append("div").attr("class","tooltip").style("opacity",0)};