"use strict";function kmeans(t,e,r){var n=new Array,a=new Array,i=new Array,o=!1;r||(r=function(t){return[t]});for(var l=function(t){for(var e=[],r=t[0].length,n=0;n<r;n++)e.push(t.map(function(t){return t[n]}).reduce(function(t,e){return t+e},0)/t.length);return e},s=function(t,e){for(var r=0;r<=t.length;r++)if(t[r]!==e[r])return!1;return!0},c=function(t,e){for(var r=0;r<=t.length;r++)if(s(t[r],e))return!0;return!1},u=0;u<e;u++)n[u]=new Array;var d,f,p,h=Math.round(t.length/(e+1));for(d=0;d<e;d++)p=h*(d+1),a[d]=r(t[p]);do{for(f=0;f<e;f++)n[f]=[];for(o=!1,d=0;d<t.length;d++){var y,m=-1,v=-1;for(f=0;f<e;f++)m=function(t,e){if(t=(void 0===t?"undefined":_typeof(t))===Array?t:[t],e=(void 0===e?"undefined":_typeof(e))===Array?e:[e],t.length!==e.length)throw"Number of dimensions not aligned between data points.";for(var r=0,n=0;n<t.length;n++)r+=Math.pow(t[n]-e[n],2);return Math.sqrt(r)}(a[f],r(t[d])),-1==v?(v=m,y=f):m<=v&&(y=f,v=m);n[y].push(t[d])}i=a,a=function(t){return t.map(l)}(n),o=function(t,e){for(var r=0;r<t.length;r++)if(!c(e,t[r]))return!0;return!1}(i,a)}while(1==o);return n}function MatrixViewer(t){d3.select(t).html('<div class="row px-3" style="width:100%" id="_matrixview">'+this.selectHTML+this.alertHTML+"</div>"+this.cmHTML+this.tooltipHTML),this.hideAlert(),this._parentId=t}var clusterfck=function(){var t={exports:{}};t.exports;return t.exports=function(){var t={exports:{}},e=(t.exports,function(t,e,r){this.distance=t||clusterfck.EUCLIDEAN_DISTANCE,this.merge=e||clusterfck.AVERAGE_LINKAGE,this.threshold=void 0==r?1/0:r});e.prototype={cluster:function(t,e,r){for(var n=[],a=[],i=[],o=[],l=0;l<t.length;l++){var s={canonical:t[l],key:l,index:l,size:1};n[l]=s,o[l]=s,a[l]=[],i[l]=0}for(var l=0;l<n.length;l++)for(var c=0;c<=l;c++){var u=l==c?1/0:this.distance(n[l].canonical,n[c].canonical);a[l][c]=u,a[c][l]=u,u<a[l][i[l]]&&(i[l]=c)}for(var d=this.mergeClosest(n,a,i,o),l=0;d;)r&&l%e==0&&r(n),d=this.mergeClosest(n,a,i,o),l++;return n.forEach(function(t){delete t.key,delete t.index}),n},mergeClosest:function(t,e,r,n){for(var a=0,i=1/0,o=0;o<t.length;o++){var l=t[o].key,s=e[l][r[l]];s<i&&(a=l,i=s)}if(i>=this.threshold)return!1;var c=n[a],u=n[r[a]],d={canonical:this.merge(c.canonical,u.canonical),left:c,right:u,key:c.key,size:c.size+u.size};t[c.index]=d,t.splice(u.index,1),n[c.key]=d;for(var o=0;o<t.length;o++){var s,f=t[o];c.key==f.key?s=1/0:this.merge==clusterfck.SINGLE_LINKAGE?(s=e[c.key][f.key],e[c.key][f.key]>e[u.key][f.key]&&(s=e[u.key][f.key])):this.merge==clusterfck.COMPLETE_LINKAGE?(s=e[c.key][f.key],e[c.key][f.key]<e[u.key][f.key]&&(s=e[u.key][f.key])):s=this.merge==clusterfck.AVERAGE_LINKAGE?(e[c.key][f.key]*c.size+e[u.key][f.key]*u.size)/(c.size+u.size):this.distance(f.canonical,c.canonical),e[c.key][f.key]=e[f.key][c.key]=s}for(var o=0;o<t.length;o++){var p=t[o].key;if(r[p]==c.key||r[p]==u.key){for(var i=p,h=0;h<t.length;h++){var y=t[h].key;e[p][y]<e[p][i]&&(i=y)}r[p]=i}t[o].index=o}return delete c.key,delete u.key,delete c.index,delete u.index,!0}};var r=function(t,e){return t},n=function(t,e){return t},a=function(t,e){return t},i=function(t,e){for(var r=0,n=0;n<t.length;n++)r+=Math.pow(e[n]-t[n],2);return Math.sqrt(r)},o=function(t,e){for(var r=0,n=0;n<t.length;n++)r+=Math.abs(e[n]-t[n]);return r},l=function(t,e){for(var r=0,n=0;n<t.length;n++)r=Math.max(r,Math.abs(e[n]-t[n]));return r};return clusterfck={hcluster:function(t,r,n,a,i,o){return new e(r,n,a).cluster(t,i,o)},SINGLE_LINKAGE:r,COMPLETE_LINKAGE:n,AVERAGE_LINKAGE:a,EUCLIDEAN_DISTANCE:i,MANHATTAN_DISTANCE:o,MAX_DISTANCE:l},t.exports=clusterfck,t.exports}(),t.exports}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};"undefined"!=typeof d3&&(d3.kmeans=kmeans),MatrixViewer.prototype.selectHTML='<p>Order by: <select id="order">  <option value="rmsd">RMSD</option> <option value="name">PDB ID</option> <option value="group">cluster (k-means)</option>     </select>',MatrixViewer.prototype.alertHTML='<div class="alert alert-light col-6" role="alert" id="alertbox">&nbsp;</div>',MatrixViewer.prototype.cmHTML='<div class="row"><div class="col-12"><matrix id="matrix"></matrix></div>',MatrixViewer.prototype.tooltipHTML='<div id="tooltip" class="hidden"><p><span id="value"></p></div></div>',MatrixViewer.prototype.clear=function(){this.hideAlert(),this._width=0,this.data=null,d3.select("matrix").select("svg").remove(),d3.select("matrix").select("*").remove()},MatrixViewer.prototype.alert=function(t){d3.select("#alertbox").html(t)},MatrixViewer.prototype.hideAlert=function(){d3.select("#alertbox").html("")},MatrixViewer.prototype._parse=function(t){var e=t.matrix,r=t.numClusters||3;try{var n=[],a=d3.dsvFormat("\t"),i=[],o={},l=0,s=[],c=a.parseRows(e,function(t,e){var r,a,c=t[0],u=t[1],d=parseFloat(t[2]),f=parseFloat(t[3]);return r=o[c],r||(l=n.length,r={name:c,index:l},o[c]=r,n.push(r),s[r.index]=s[r.index]||[],s[r.index][r.index]=0),a=o[u],a||(l=n.length,a={name:u,index:l},o[u]=a,n.push(a),s[a.index]=s[a.index]||[],s[a.index][a.index]=0),s[r.index][a.index]=f,s[a.index][r.index]=f,i.push({source:r.index,target:a.index,value:f}),{pdb1:c,pdb2:u,contact:d,rmsd:f}});i=this.clusterKmeans(i,r);this.hcluster(s);return{matrix:c,pdbs:n,links:i}}catch(t){return this.alert("Wrong input format. Required format: [PDB1 PDB2 contact RMSD]"),null}},MatrixViewer.prototype.hcluster=function(t){function e(t){var e=t.left||null,r=t.right||null,n=[];return e&&n.push(e),r&&n.push(r),n.length>0?n:null}var r=clusterfck.hcluster(t);return d3.hierarchy(r[0],e).leaves()},MatrixViewer.prototype.clusterKmeans=function(t,e){var r=d3.kmeans(t,e,function(t){return t.value}),n=new Array;return r.forEach(function(t,e){t.forEach(function(t,r){t.group=e+1}),n=n.concat(t)}),n},MatrixViewer.prototype.draw=function(t){if(this.clear(),null===t)return void this.alert("Input data is empty.");var e=parseInt(d3.select(this._parentId).style("padding-left")),r=parseInt(d3.select(this._parentId).style("padding-right"));this._width=parseInt(d3.select(this._parentId).style("width"))-e-r-15,this.data=this._parse(t),null!==this.data&&this._draw();var n=document.getElementById("order");n.options[0].selected=!0,n.dispatchEvent(new Event("change"))},MatrixViewer.prototype._draw=function(){function t(t){c.domain(h[t]);var e=o.transition().duration(2e3);e.selectAll(".row").delay(function(t,e){return 4*c(e)}).attr("transform",function(t,e){return"translate(0,"+c(e)+")"}).selectAll(".cell").delay(function(t){return 4*c(t.x)}).attr("x",function(t){return c(t.x)}),e.selectAll(".column").delay(function(t,e){return 4*c(e)}).attr("transform",function(t,e){return"translate("+c(e)+")rotate(-90)"})}function e(t){d3.selectAll(".row text").classed("active",function(e,r){return r==t.y}),d3.selectAll(".column text").classed("active",function(e,r){return r==t.x}),y.transition().duration(200).style("opacity",.9);var e=l[t.x][t.y].group;y.html(a[t.y].name+" ["+e+"]</br>"+a[t.x].name+" ["+e+"]</br>RMSD: "+t.z).style("left",d3.event.pageX+30+"px").style("top",d3.event.pageY-50+"px")}function r(){d3.selectAll("text").classed("active",!1),y.transition().duration(500).style("opacity",0)}var n=this,a=n.data.pdbs,i={top:150,right:50,bottom:0,left:50,legend:{top:-100,left:10,width:50,height:50}},o=(i.legend.left,i.legend.width,d3.select("matrix").append("svg").attr("width",700+i.left+i.right).attr("height",700+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")"));o.append("rect").attr("class","background").attr("width",700).attr("height",700);var l=[],s=a.length,c=d3.scaleBand().range([0,700]).domain(d3.range(s)),u=d3.scaleOrdinal(d3.schemeCategory10);a.forEach(function(t){l[t.index]=d3.range(s).map(function(e){return{x:e,y:t.index,z:0}})}),n.data.links.forEach(function(t){l[t.source][t.target].z+=t.value,l[t.target][t.source].z+=t.value,l[t.source][t.target].group=t.group,l[t.target][t.source].group=t.group});var d=o.selectAll(".row").data(l).enter().append("g").attr("class","row").attr("transform",function(t,e){return"translate(0,"+c(e)+")"}),f=(d.selectAll(".cell").data(function(t){return t.filter(function(t){return t.z>0})}).enter().append("rect").attr("class","cell").attr("x",function(t){return c(t.x)}).attr("width",c.bandwidth()).attr("height",c.bandwidth()).style("fill",function(t){return u(t.group)}).on("mouseover",e).on("mouseout",r),o.selectAll(".column").data(l).enter().append("g").attr("class","column").attr("transform",function(t,e){return"translate("+c(e)+")rotate(-90)"}));d.append("text").attr("class","label").attr("x",-5).attr("y",c.bandwidth()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return a[e].name}),f.append("text").attr("class","label").attr("y",100).attr("y",c.bandwidth()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,e){return a[e].name});var p=d3.legendColor().title("Cluster id").labelFormat(d3.format(".0f")).shapeWidth(30).scale(u).orient("horizontal").labelOffset(12);o.append("g").attr("transform","translate("+i.legend.left+","+i.legend.top+")").call(p);var h={name:d3.range(s).sort(function(t,e){return d3.ascending(a[t].name,a[e].name)}),group:d3.range(s).sort(function(t,e){return t=Math.min(s-2,t),e=Math.min(s-2,e),l[t][t+1].value-l[e][e+1].value}),rmsd:d3.range(s).sort(function(t,e){return l[1][t].z-l[1][e].z})};d3.select("#order").on("change",function(){t(this.value)}),d.append("line").attr("x2",700),f.append("line").attr("x1",-700);var y=d3.select("body").append("div").attr("class","tooltip").style("opacity",0)};